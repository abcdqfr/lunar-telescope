#!/usr/bin/env bash
set -euo pipefail

# Lunar Telescope deterministic pre-push hook
#
# This prevents public CI spam by running local preflight checks before push.
# It performs no network fetches and respects the hybrid contract:
# - baseline must always pass
# - optional tools are best-effort
#
# Enable with:
#   git config core.hooksPath .githooks
#
# Policy note:
# Git allows bypassing hooks. In this project, bypassing pre-push verification is a
# violation of project policy. Enforce server-side with branch protection rules.

echo "[pre-push] Running Lunar Telescope preflight (baseline always, CI-equivalent if available)..."

# Baseline must always pass (no Rust/Python/json-c required).
make preflight-baseline

# CI-equivalent preflight is required for PR readiness, but can only be enforced
# if the toolchain is present on the developer machine.
if command -v python3 >/dev/null 2>&1 && command -v cargo >/dev/null 2>&1 && command -v pkg-config >/dev/null 2>&1; then
  make preflight-ci
else
  echo "[pre-push] NOTE: skipping preflight-ci (missing python3/cargo/pkg-config)."
  echo "[pre-push]       PR route will enforce CI server-side; install deps to catch failures earlier."
fi

echo "[pre-push] OK"



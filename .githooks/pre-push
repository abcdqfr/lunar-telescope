#!/usr/bin/env bash
set -euo pipefail

# Lunar Telescope deterministic pre-push hook
#
# This prevents public CI spam by running local preflight checks before push.
# It performs no network fetches and respects the hybrid contract:
# - baseline must always pass
# - optional tools are best-effort
#
# Enable with:
#   git config core.hooksPath .githooks
#
# Policy note:
# Git allows bypassing hooks. In this project, bypassing pre-push verification is a
# violation of project policy. Enforce server-side with branch protection rules.

echo "[pre-push] Running Lunar Telescope preflight (baseline + strict)..."

# Baseline must always pass (no Rust/Python/json-c required).
make preflight-baseline

# Stricter-than-CI local preflight (includes C coverage).
# Policy: this should be mandatory for pushes to cut down public CI failures.
if command -v nix >/dev/null 2>&1; then
  nix develop -c make preflight-strict
elif command -v python3 >/dev/null 2>&1 && command -v cargo >/dev/null 2>&1 && command -v pkg-config >/dev/null 2>&1 && command -v gcovr >/dev/null 2>&1; then
  make preflight-strict
else
  echo "[pre-push] ERROR: missing strict preflight toolchain."
  echo "[pre-push]        Recommended: install Nix and rerun (or enter: nix develop)."
  echo "[pre-push]        Fallback: install python3, cargo, pkg-config, json-c dev, and gcovr."
  exit 1
fi

echo "[pre-push] OK"


